<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
	xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

	<changeSet
		id="004:01-create-ticket-iteration-completed-index"
		author="flowinquiry">
		<createIndex indexName="idx_ticket_iteration_completed"
			tableName="fw_ticket">
			<column name="iteration_id" />
			<column name="is_completed" />
		</createIndex>
	</changeSet>

	<changeSet id="004:02-create-iteration-proj-start-idx-active"
		author="flowinquiry">
		<createIndex
			indexName="idx_iteration_project_start_date_status"
			tableName="fw_project_iteration">
			<column name="project_id" />
			<column name="start_date" />
			<column name="status" />
		</createIndex>
	</changeSet>

	<changeSet id="004:03-create-ticket-overdue-index"
		author="flowinquiry">
		<createIndex indexName="idx_ticket_overdue"
			tableName="fw_ticket">
			<column name="is_deleted" />
			<column name="is_completed" />
			<column name="estimated_completion_date" />
			<column name="id" />
		</createIndex>
	</changeSet>

	<changeSet id="004:04-create-workflow-history-overdue-index"
		author="flowinquiry">
		<createIndex indexName="idx_workflow_history_overdue"
			tableName="fw_workflow_transition_history">
			<column name="ticket_id" />
			<column name="sla_due_date" />
			<column name="status" />
		</createIndex>
	</changeSet>

    <changeSet id="004:04-create-project-integration-table" author="flowinquiry">

        <createTable tableName="fw_project_integration">
            <column name="id" type="BIGSERIAL" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <column name="project_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>

            <column name="integration_type" type="VARCHAR(50)" defaultValue="GITHUB">
                <constraints nullable="false"/>
            </column>

            <column name="config" type="JSONB">
                <constraints nullable="true"/>
            </column>

            <column name="enabled" type="BOOLEAN" defaultValue="false">
                <constraints nullable="false"/>
            </column>

            <column name="webhook_secret" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>

            <column name="repo_name" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>

            <column name="created_by" type="BIGINT"/>
            <column name="created_at" type="TIMESTAMPTZ"/>
            <column name="modified_by" type="BIGINT"/>
            <column name="modified_at" type="TIMESTAMPTZ"/>

            <column name="tenant_id" type="UUID"
                    defaultValue="00000000-0000-0000-0000-000000000001">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint
                baseTableName="fw_project_integration"
                baseColumnNames="project_id"
                referencedTableName="fw_project"
                referencedColumnNames="id"
                onDelete="CASCADE"
                constraintName="fk_project_integration"/>

    </changeSet>
</databaseChangeLog>
