<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
	xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">
	<changeSet id="003:01-create-tenant-table"
		author="flowinquiry">
		<createTable tableName="fw_tenant">
			<column name="id" type="UUID">
				<constraints primaryKey="true" nullable="false" />
			</column>

			<column name="name" type="VARCHAR(100)">
				<constraints nullable="false" />
			</column>

			<!-- Unique human-readable and URL-safe tenant identifier -->
			<column name="slug" type="VARCHAR(100)">
				<constraints nullable="false" unique="true" />
			</column>

			<!-- Actual domain used to route: could be subdomain or dedicated domain -->
			<column name="domain" type="VARCHAR(255)">
				<constraints unique="true" nullable="false" />
			</column>

			<!-- Indicates whether tenant uses subdomain or full custom domain -->
			<column name="access_type" type="VARCHAR(20)"
				defaultValue="SUBDOMAIN">
				<constraints nullable="false" />
			</column>

			<column name="created_at" type="TIMESTAMP">
				<constraints nullable="false" />
			</column>

			<column name="modified_at" type="TIMESTAMP">
				<constraints nullable="false" />
			</column>
		</createTable>

		<!-- Insert default tenant for self-host mode -->
		<insert tableName="fw_tenant">
			<column name="id" value="00000000-0000-0000-0000-000000000001" />
			<column name="name" value="Self Host" />
			<column name="slug" value="self-host" />
			<column name="domain" value="localhost" />
			<column name="access_type" value="SELF_HOSTED" />
			<column name="created_at" valueDate="NOW()" />
			<column name="modified_at" valueDate="NOW()" />
		</insert>
	</changeSet>

	<changeSet
		id="003:02-alter-tenant_relationship-to-activity-log-table"
		author="flowinquiry">
		<addColumn tableName="fw_activity_log">
			<column name="tenant_id" type="UUID" />
		</addColumn>

		<update tableName="fw_activity_log">
			<column name="tenant_id"
				value="00000000-0000-0000-0000-000000000001" />
		</update>

		<addNotNullConstraint tableName="fw_activity_log"
			columnName="tenant_id" columnDataType="UUID" />

		<addForeignKeyConstraint
			baseTableName="fw_activity_log" baseColumnNames="tenant_id"
			constraintName="fk_activity_log_tenant"
			referencedTableName="fw_tenant" referencedColumnNames="id" />
		<createIndex indexName="idx_fw_activity_log_tenant_id"
			tableName="fw_activity_log">
			<column name="tenant_id" />
		</createIndex>
	</changeSet>
	<changeSet
		id="003:03-alter-tenant_relationship-to-app-settings-table"
		author="flowinquiry">
		<addColumn tableName="fw_app_settings">
			<column name="tenant_id" type="UUID" />
		</addColumn>

		<update tableName="fw_app_settings">
			<column name="tenant_id"
				value="00000000-0000-0000-0000-000000000001" />
		</update>

		<addNotNullConstraint tableName="fw_app_settings"
			columnName="tenant_id" columnDataType="UUID" />

		<addForeignKeyConstraint
			baseTableName="fw_app_settings" baseColumnNames="tenant_id"
			constraintName="fk_fw_app_settings_tenant"
			referencedTableName="fw_tenant" referencedColumnNames="id" />
		<createIndex indexName="idx_fw_app_settings_tenant_id"
			tableName="fw_app_settings">
			<column name="tenant_id" />
		</createIndex>
	</changeSet>
	<changeSet
		id="003:04-alter-tenant_relationship-to-authority-table"
		author="flowinquiry">
		<addColumn tableName="fw_authority">
			<column name="tenant_id" type="UUID" />
		</addColumn>

		<update tableName="fw_authority">
			<column name="tenant_id"
				value="00000000-0000-0000-0000-000000000001" />
		</update>

		<addNotNullConstraint tableName="fw_authority"
			columnName="tenant_id" columnDataType="UUID" />

		<addForeignKeyConstraint
			baseTableName="fw_authority" baseColumnNames="tenant_id"
			constraintName="fk_fw_authority_tenant"
			referencedTableName="fw_tenant" referencedColumnNames="id" />
		<createIndex indexName="idx_fw_authority_tenant_id"
			tableName="fw_authority">
			<column name="tenant_id" />
		</createIndex>
	</changeSet>
	<changeSet
		id="003:05-alter-tenant_relationship-to-authority-resource-permission-table"
		author="flowinquiry">
		<addColumn tableName="fw_authority_resource_permission">
			<column name="tenant_id" type="UUID" />
		</addColumn>

		<update tableName="fw_authority_resource_permission">
			<column name="tenant_id"
				value="00000000-0000-0000-0000-000000000001" />
		</update>

		<addNotNullConstraint
			tableName="fw_authority_resource_permission" columnName="tenant_id"
			columnDataType="UUID" />

		<addForeignKeyConstraint
			baseTableName="fw_authority_resource_permission"
			baseColumnNames="tenant_id"
			constraintName="fk_fw_authority_resource_permission_tenant"
			referencedTableName="fw_tenant" referencedColumnNames="id" />
		<createIndex
			indexName="idx_fw_authority_resource_permission_tenant_id"
			tableName="fw_authority_resource_permission">
			<column name="tenant_id" />
		</createIndex>
	</changeSet>
	<changeSet
		id="003:05-alter-tenant_relationship-to-comment-table"
		author="flowinquiry">
		<addColumn tableName="fw_comment">
			<column name="tenant_id" type="UUID" />
		</addColumn>

		<update tableName="fw_comment">
			<column name="tenant_id"
				value="00000000-0000-0000-0000-000000000001" />
		</update>

		<addNotNullConstraint tableName="fw_comment"
			columnName="tenant_id" columnDataType="UUID" />

		<addForeignKeyConstraint
			baseTableName="fw_comment" baseColumnNames="tenant_id"
			constraintName="fk_fw_comment_tenant" referencedTableName="fw_tenant"
			referencedColumnNames="id" />
		<createIndex indexName="idx_fw_comment_tenant_id"
			tableName="fw_comment">
			<column name="tenant_id" />
		</createIndex>
	</changeSet>
	<changeSet
		id="003:06-alter-tenant_relationship-to-entity-attachment-table"
		author="flowinquiry">
		<addColumn tableName="fw_entity_attachment">
			<column name="tenant_id" type="UUID" />
		</addColumn>

		<update tableName="fw_entity_attachment">
			<column name="tenant_id"
				value="00000000-0000-0000-0000-000000000001" />
		</update>

		<addNotNullConstraint
			tableName="fw_entity_attachment" columnName="tenant_id"
			columnDataType="UUID" />

		<addForeignKeyConstraint
			baseTableName="fw_entity_attachment" baseColumnNames="tenant_id"
			constraintName="fk_fw_entity_attachment_tenant"
			referencedTableName="fw_tenant" referencedColumnNames="id" />
		<createIndex
			indexName="idx_fw_entity_attachment_tenant_id"
			tableName="fw_entity_attachment">
			<column name="tenant_id" />
		</createIndex>
	</changeSet>
</databaseChangeLog>